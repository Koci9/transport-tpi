version: "3.8"

services:
  # -------------------
  # Keycloak (Auth)
  # -------------------
  keycloak:
    image: quay.io/keycloak/keycloak:21.1.1
    container_name: keycloak
    environment:
      # admin UI
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      # start in dev mode (auto-reload, import support)
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    # import realm if file exists on host
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
      - keycloak_data:/opt/keycloak/data
    command: ["start-dev"]
    ports:
      - "8080:8080"
    restart: unless-stopped
    networks:
      - tpi-network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/realms/master || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12

  # -------------------
  # Postgres (DB)
  # -------------------
  postgres:
    image: postgres:15
    container_name: postgres
    environment:
      POSTGRES_DB: transportdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - pg_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    networks:
      - tpi-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d transportdb || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # -------------------
  # Gateway (API Gateway)
  # -------------------
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    image: transport-tpi/gateway:latest
    container_name: gateway
    environment:
      - KEYCLOAK_ISSUER=http://keycloak:8080/realms/transport-tpi
      - SPRING_PROFILES_ACTIVE=default
    ports:
      - "8080:8080"
    depends_on:
      - keycloak
      - postgres
    restart: unless-stopped
    networks:
      - tpi-network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep -q 'UP' || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 8

  # -------------------
  # Solicitud Service
  # -------------------
  solicitud-service:
    build:
      context: ./solicitud-service
      dockerfile: Dockerfile
    image: transport-tpi/solicitud-service:latest
    container_name: solicitud-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/transportdb
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/transport-tpi
      SPRING_PROFILES_ACTIVE: default
    ports:
      - "8081:8081"
    depends_on:
      - postgres
      - keycloak
    restart: unless-stopped
    networks:
      - tpi-network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8081/actuator/health | grep -q 'UP' || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 8

  # -------------------
  # Ruta Service
  # -------------------
  ruta-service:
    build:
      context: ./ruta-service
      dockerfile: Dockerfile
    image: transport-tpi/ruta-service:latest
    container_name: ruta-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/transportdb
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/transport-tpi
      GOOGLE_MAPS_API_KEY: "${GOOGLE_MAPS_API_KEY:-}"
      SPRING_PROFILES_ACTIVE: default
    ports:
      - "8082:8082"
    depends_on:
      - postgres
      - keycloak
    restart: unless-stopped
    networks:
      - tpi-network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8082/actuator/health | grep -q 'UP' || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 8

  # -------------------
  # Tarifas Service
  # -------------------
  tarifas-service:
    build:
      context: ./tarifas-service
      dockerfile: Dockerfile
    image: transport-tpi/tarifas-service:latest
    container_name: tarifas-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/transportdb
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/transport-tpi
      SPRING_PROFILES_ACTIVE: default
    ports:
      - "8083:8083"
    depends_on:
      - postgres
      - keycloak
    restart: unless-stopped
    networks:
      - tpi-network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8083/actuator/health | grep -q 'UP' || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 8

# -------------------
# Volumes and network
# -------------------
volumes:
  pg_data:
  keycloak_data:

networks:
  tpi-network:
    driver: bridge